var c=document.getElementById("console"),ctx=c.getContext("2d");font="18pt clacon";ctx.font=font;var charWidth=13,charHeight=1.9*charWidth,cmd="",user="guest",host="labienus.dev",darkAmber="#FFB000",lightAmber="#FFCC00",darkGreen="#33FF33",lightGreen="#9fff9f",shadowBlur=15,blue="#0b71ff",gray="#9ea1aa",dark="#0c0c0c",color=darkGreen,shadowColor=darkGreen,xmargin=15,preWidth=charWidth*(user.length+host.length+5)+xmargin,y=0,cheight=document.getElementById("stage").offsetHeight,cwidth=document.getElementById("stage").offsetWidth;
c.width=cwidth;c.height=cheight;var initialAlpha=.8,da=.03,cc=document.getElementById("carat"),cctx=cc.getContext("2d");cc.width=cwidth;cc.height=cheight;var f=document.getElementById("fade"),ftx=f.getContext("2d");f.width=cwidth;f.height=cheight;var fading=[];
function persist(){ftx.clearRect(0,0,cwidth,cheight);for(let a=0;a<fading.length;a++){let b=fading[a];ftx.globalAlpha=b.alpha;0<b.alpha&&(b.alpha-=da,"text"==b.type?ftx.fillText(b.s,b.x,b.y):"canvas"==b.type?ftx.drawImage(b.canvas,0,0):"rect"==b.type&&ftx.fillRect(b.x,b.y,b.w,b.h))}fading=fading.filter(a=>0<a.alpha)}var scanlineY=0;function sweep(){scanlineY<=cheight&&fading.push({type:"rect",x:0,y:scanlineY,w:cwidth,h:1,alpha:.2});scanlineY+=3;scanlineY>=cwidth+2E3&&(scanlineY=0)}
var g=document.getElementById("glow"),gtx=g.getContext("2d");g.width=cwidth;g.height=cheight;function animate(){persist();glow();noise();sweep();requestAnimationFrame(animate)}
function glow(){gtx.clearRect(0,0,cwidth,cheight);gtx.shadowBlur=shadowBlur;gtx.shadowColor=shadowColor;gtx.drawImage(c,0,0);gtx.drawImage(f,0,0);gtx.drawImage(cc,0,0);gtx.globalCompositeOperation="destination-out";gtx.shadowBlur=0;gtx.drawImage(c,0,0);gtx.drawImage(f,0,0);gtx.drawImage(cc,0,0);gtx.globalCompositeOperation="source-over"}var n=document.getElementById("noise"),ntx=n.getContext("2d");n.width=cwidth;n.height=cheight;var shift=1,missedRowChance=.001,missedColumnChance=.01;
function noise(){const a=ctx.getImageData(0,0,cwidth,cheight),b=new Uint32Array(a.data.buffer),d=new Uint32Array(b.length);for(let h=0;h<cheight;h++){if(Math.random()<missedRowChance){var e=h*cwidth;d.set(b.subarray(e,e+cwidth),e)}for(e=0;e<cwidth;e++)Math.random()<missedColumnChance&&(d[.5>Math.random()?h*cwidth+(e+shift):h*cwidth+(e-shift)]=b[h*cwidth+e])}a.data.set(new Uint8ClampedArray(d.buffer));ntx.putImageData(a,0,0)}ctx.imageSmoothingEnabled=!1;ctx.fillStyle=cctx.fillStyle=ftx.fillStyle=color;
ctx.font=cctx.font=ftx.font=font;window.addEventListener("load",main);function main(){title();animate();window.addEventListener("keydown",type)}var db=new OffscreenCanvas(cwidth,cheight);dbx=db.getContext("2d");dbx.fillStyle=color;dbx.font=font;var screen="",dx=xmargin,dy=0;
function type(a){"32"==a.keyCode&&a.preventDefault();if("Backspace"===a.key){if(x>preWidth){decarat();x-=charWidth;screen=screen.slice(0,-1);for(a=0;a<screen.length;a++){let b=screen[a];"\n"==b?(dx=xmargin,dy+=charHeight):(dbx.fillText(b,dx,dy),dx+=charWidth)}dx=xmargin;dy=0;ctx.clearRect(0,0,cwidth,cheight);ctx.globalCompositeOperation="copy";ctx.drawImage(db,0,0);ctx.globalCompositeOperation="source-over";dbx.clearRect(0,0,cwidth,cheight);cmd=cmd.slice(0,-1);carat()}}else if("Enter"==a.key){decarat();
cmd=cmd.replace(/\r?\n|\r/,"");switch(cmd){case "":execute(function(){displaypre()});break;case "labienus":title();break;case "clear":a=new OffscreenCanvas(cwidth,cheight);a.getContext("2d").drawImage(c,0,0);fading.push({type:"canvas",canvas:a,alpha:initialAlpha});ctx.clearRect(0,0,cwidth,cheight);screen="";y=0;displaypre();break;case "help":execute(function(){displayln("Currently implemented commands:\n\tclear\n\thelp\n\twasm\n\tlabienus");displaypre()});break;case "wasm":WebAssembly.instantiateStreaming(fetch("program.wasm"),
{imports:{imported_func:b=>display}}).then(b=>{b=new Int8Array(b.instance.exports.memory.buffer,b.instance.exports.getString(),12);let d=String.fromCharCode.apply(null,b);execute(function(){displayln(d);displaypre()})});break;default:execute(function(){displayln('Type "help" for some sample commands.');displaypre()})}cmd=""}else"Shift"!=a.key&&"Control"!=a.key&&(decarat(),display(a.key),carat(),cmd+=a.key)}var residue=!1;
function display(a){screen+=a;for(let d=0;d<a.length;d++){var b=a[d];"\n"==b?(x=xmargin,y+=charHeight,y>=cheight&&(residue=!0,b=screen.indexOf("\n",1),screen=screen.substring(b),ctx.clearRect(0,0,cwidth,charHeight+4),ctx.globalCompositeOperation="copy",ctx.drawImage(c,0,-charHeight),ctx.globalCompositeOperation="source-over",y-=charHeight)):(ctx.fillText(b,x,y),x+=charWidth)}}
function execute(a){let b=new OffscreenCanvas(cwidth,cheight);b.getContext("2d").drawImage(c,0,0);a();1==residue&&(fading.push({type:"canvas",canvas:b,alpha:initialAlpha}),residue=!1)}function displayln(a,b){display("\n"+a,b)}function displaypre(){displayln(user+"@"+host+":~$ ");carat()}function carat(){cctx.fillText("\u2588",x,y)}function blink(){setBlink="on";setInterval(()=>{"on"==setBlink?(setBlink="off",carat()):(setBlink="on",decarat())},500)}
function decarat(){cctx.clearRect(0,0,cwidth,cheight);fading.push({type:"text",s:"\u2588",x,y,alpha:initialAlpha})}function decaratzero(){fading.push({type:"text",s:"\u2588",x:0,y,alpha:initialAlpha})}
function title(){execute(function(){displayln(" ")});setTimeout(()=>{execute(function(){displayln("  \u2588\u2557    \u2588\u2588\u2557 \u2554\u2588\u2588\u2557 \u2588\u2588\u2588\u2557\u2588\u2588\u2588\u2557\u2588\u2557 \u2588\u2557\u2588\u2557 \u2588\u2557\u2588\u2588\u2588\u2557");decaratzero()})},250);setTimeout(()=>{execute(function(){displayln("  \u2588\u2551   \u2588\u256c\u2550\u2588\u2557\u2588\u2550\u2588\u2551  \u2588\u2563 \u2588\u256c\u2550 \u2588\u2588\u2557\u2588\u2551\u2588\u2563 \u2588\u2563\u2588\u2563      \u2588\u2557");
decaratzero()})},500);setTimeout(()=>{execute(function(){displayln("  \u2588\u2551   \u2588\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2557 \u2588\u2563 \u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2588\u2551\u2588\u2563 \u2588\u2563\u2588\u2588\u2588\u2557  \u2584\u2584\u2588\u2563\u2588\u2580\u2588\u2557\u2588\u2563\u2588\u2557");decaratzero()})},750);setTimeout(()=>{execute(function(){displayln("  \u2588\u2551   \u2588\u256c\u2550\u2588\u2551\u2588\u256c\u2550\u2588\u2551 \u2588\u2551 \u2588\u256c\u2550\u255d\u2588\u256c\u2588\u2588\u2551\u2588\u2563 \u2588\u2563\u255a\u2550\u2588\u2563  \u2588 \u2588\u2563\u2588\u2580\u2580\u2569\u2588\u2563\u2588\u2563");
decaratzero()})},1E3);setTimeout(()=>{execute(function(){displayln("  \u255a\u2588\u2588\u2588\u2557\u2588\u2551 \u2588\u2551\u2588\u2588\u2588\u2588\u256c\u2588\u2588\u2588\u2551\u2588\u2588\u2588\u2557\u2588\u2551\u2560\u2588\u2551\u2588\u2588\u2588\u2588\u2563\u2588\u2588\u2588\u2563\u2588\u2557\u2588\u2588\u2588\u2563\u2588\u2588\u2588\u2557 \u2588\u2563");decaratzero()})},1250);setTimeout(()=>{execute(function(){displayln("  \u255a\u2550\u2550\u2569\u2569\u2569\u255d \u255a\u2569\u2569\u2550\u2550\u2569\u2569\u2569\u2550\u2569\u2569\u2569\u2550\u2550\u2569\u2569\u255d\u255a\u2569\u2569\u2569\u2550\u2550\u2569\u2569\u2569\u2550\u2569\u2550\u2569\u2569\u2569\u2550\u2550\u2569\u2569\u2550\u2569\u2569\u2550\u2569\u2569");
decaratzero()})},1500);setTimeout(function(){let a=new Date;execute(function(){displayln("");displayln(a.getUTCDate()+"-"+a.getUTCMonth()+"-"+a.getUTCFullYear());displayln(a.getUTCHours()+":"+("0"+a.getUTCMinutes()).slice(-2)+" UTC")})},1600);setTimeout(()=>{execute(function(){displaypre()})},2100)};
